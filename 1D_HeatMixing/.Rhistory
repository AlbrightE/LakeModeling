# 4.9 * 10^(-3) # Stefan-Boltzmann constant in [J (m2 d K4)-1]
eps <- 0.97 # emissivity of water
cp <- 4184 # specific heat (J/kg/C)
c1 <- 0.47 # Bowen's coefficient
a <- 7 # constant
c <- 9e4 # empirical constant
g <- 9.81  # gravity (m/s2)
# vertical heating
reflect <- 0.6 # fraction of reflected solar radiation
infra = 0.3 # fraction infrared radiation
kd = 1 # 0.2# 1.0 #0.2 # light attenuation coefficient
emissivity = 0.97
sigma = 5.67 * 10^(-8)
p2 = 1
B = 0.61
longwave <- function(cc, sigma, Tair, ea, emissivity, Jlw){  # longwave radiation into
lw = emissivity * Jlw
return(lw)
}
longwave <- function(cc, sigma, Tair, ea, emissivity, Jlw){  # longwave radiation into
Tair = Tair + 273.15
p <- (1.33 * ea/Tair)
Ea <- 1.24 * (1 + 0.17 * cc**2) * p**(1/7)
lw <- emissivity * Ea *sigma * Tair**4
return(lw)
}
backscattering <- function(emissivity, sigma, Twater){ # backscattering longwave
# radiation from the lake
Twater = Twater + 273.15
back = (eps * sigma * (Twater )^4)
return((-1) * back)
}
sensible <- function(p2, B, Tair, Twater, Uw){ # convection / sensible heat
Twater = Twater + 273.15
Tair = Tair + 273.15
fu = 4.4 + 1.82 * Uw + 0.26 *(Twater - Tair)
sensible <- ( p2 * B * fu * (Twater - Tair))
return((-1) * sensible)
}
latent <- function(Tair, Twater, Uw, p2, pa, ea){ # evaporation / latent heat
Twater = Twater + 273.15
Tair = Tair + 273.15
Pressure = pa / 100
fu = 4.4 + 1.82 * Uw + 0.26 *(Twater - Tair)
fw = 0.61 * (1 + 10^(-6) * Pressure * (4.5 + 6 * 10^(-5) * Twater**2))
ew = fw * 10 * ((0.7859+0.03477* Twater)/(1+0.00412* Twater))
latent = fu * p2 * (ew - ea * 1.33) #* 1/6
return((-1) * latent)
}
## plot initial profile
plot( u, seq(0, nx * dx, length.out=(nx)),
ylim = rev(range(seq(0, dx * nx, length.out=(nx)))), xlim = c(0,35),
type ='l');
um <- matrix(NA, ncol = floor(nt/dt), nrow = nx)
kzm <- matrix(NA, ncol = floor(nt/dt), nrow = nx)
n2m <- matrix(NA, ncol = floor(nt/dt), nrow = nx)
Hts <- rep(NA, length = floor(nt/dt))
Swf <- rep(NA, length = floor(nt/dt))
Lwf <- rep(NA, length = floor(nt/dt))
BLwf <- rep(NA, length = floor(nt/dt))
Lf <- rep(NA, length = floor(nt/dt))
Sf <- rep(NA, length = floor(nt/dt))
mix <- rep(NA, length = floor(nt/dt))
therm.z <- rep(NA, length = floor(nt/dt))
mix.z <- rep(NA, length = floor(nt/dt))
Him <- rep(NA, length = floor(nt/dt))
startDate <- daily_meteo$datetime[1]
densThresh <- 1e-4
ice = FALSE
Hi= 0
iceT <- 6
## modeling code for vertical 1D mixing and heat transport
for (n in 1:floor(nt/dt)){  #iterate through time
print(paste0(round(n*100/floor(nt/dt),3),' %'))
un = u # prior temperature values
kz = eddy_diffusivity(calc_dens(un), depth, 9.81, 998.2, ice) / 86400
if (ice){
kzn = kz
absorp = 0.85
} else {
kzn = kz
absorp = 1-reflect# 0.3
}
kzm[, n] <- kzn
## (1) Heat addition
# surface heat flux
Q <- (absorp * Jsw(n * dt) + longwave(cc = CC(n * dt), sigma = sigma, Tair = Tair(n * dt), ea = ea(n * dt), emissivity = emissivity, Jlw = Jlw(n * dt)) + #longwave(emissivity = emissivity, Jlw = Jlw(n * dt)) +
backscattering(emissivity = emissivity, sigma = sigma, Twater = un[1]) +
latent(Tair = Tair(n*dt), Twater = un[1], Uw = Uw(n *dt), p2 = p2, pa = Pa(n*dt), ea=ea(n*dt)) +
sensible(p2 = p2, B = B, Tair = Tair(n*dt), Twater = un[1], Uw = Uw(n * dt)))
# heat addition over depth
H = (1- reflect) * (1- infra) * (Jsw(n * dt))  * #
exp(-(kd ) *seq(dx,nx*dx,length.out=nx))
Hg <- (area-lead(area))/dx * Hgeo/(4181 * calc_dens(un[1]))
Hg[which(is.na(Hg))] <- min(Hg, na.rm = TRUE)
# add heat to all layers
# un[1] = un[1] +    Q * area[1]/(dx)*1/(4184 * calc_dens(un[1]) ) * dt/area[1]
# un <- un  + (H * area/(dx) * 1/(4184 * calc_dens(un) ))* dt/area
# save variables for model diagnostics
Hts[n] <-  Q *  area[1]/(area[1]*dx)*1/(4181 * calc_dens(un[1]) ) # append(Hts, Q *  area[1]/(area[1]*dx)*1/(4181 * calc_dens(un[1]) ))
Swf[n] <-  absorp * Jsw(n * dt) # append(Swf, 0.3 * Jsw(n * dt))
Lwf[n] <-  longwave(cc = CC(n * dt), sigma = sigma, Tair = Tair(n * dt), ea = ea(n * dt), emissivity = emissivity, Jlw = Jlw(n * dt))#longwave(emissivity = emissivity, Jlw = Jlw(n * dt))  #append(Lwf, longwave(emissivity = emissivity, Jlw = Jlw(n * dt)) )
BLwf[n] <-  backscattering(emissivity = emissivity, sigma = sigma, Twater = un[1]) #append(BLwf, backscattering(emissivity = emissivity, sigma = sigma, Twater = un[1]))
Lf[n] <- latent(Tair = Tair(n*dt), Twater = un[1], Uw = Uw(n *dt), p2 = p2, pa = Pa(n*dt), ea=ea(n*dt)) #append(Lf, latent(Tair = Tair(n*dt), Twater = un[1], Uw = Uw(n *dt), p2 = p2, pa = Pa(n*dt), ea=ea(n*dt)) )
Sf[n] <- sensible(p2 = p2, B = B, Tair = Tair(n*dt), Twater = un[1], Uw = Uw(n * dt)) #append(Sf, sensible(p2 = p2, B = B, Tair = Tair(n*dt), Twater = un[1], Uw = Uw(n * dt)))
## (2) DIFFUSION
# surface layer
u[1] = un[1] +
(Q * area[1]/(dx)*1/(4184 * calc_dens(un[1]) ) +
abs(H[1+1]-H[1]) * area[1]/(dx) * 1/(4184 * calc_dens(un[1]) ) +
Hg[1]) * dt/area[1]
# all other layers in between
for (i in 2:(nx-1)){
u[i] = un[i] +
(area[i] * kzn[i] * 1 / dx**2 * (un[i+1] - 2 * un[i] + un[i-1]) +
abs(H[i+1]-H[i]) * area[i]/(dx) * 1/(4184 * calc_dens(un[i]) ) +
Hg[i])* dt/area[i]
}
# bottom layer
u[nx] = un[nx] +
abs(H[nx]-H[nx-1]) * area[nx]/(area[nx]*dx) * 1/(4181 * calc_dens(un[nx]) +
Hg[nx]/area[nx]) * dt
# j <- length(volume)
# y <- array(0, c(j,j))
#
# # Linearized heat conservation equation matrix (diffusion only)
# az <- (dt/dx) * kzn * (area / volume)                                        #coefficient for i-1
# cz <- (dt/dx) * c(kzn[-1], NA) * (c(area[-1], NA) / volume)            #coefficient for i+1
# bz <- 1 + az + cz                                                       #coefficient for i+1
# #Boundary conditions, surface
# az[1] <- 0
# #cz(1) remains unchanged
# bz[1]<- 1 + az[1] + cz[1]
# #Boundary conditions, bottom
# #az(end) remains unchanged
# cz[length(cz)] <- 0
# bz[length(bz)] <- 1 + az[length(az)] + cz[length(cz)]
# y[0 + 1:(j - 1) * (j + 1)] <- -cz[-length(bz)]	# superdiagonal
# y[1 + 0:(j - 1) * (j + 1)] <- bz	# diagonal
# y[2 + 0:(j - 2) * (j + 1)] <- -az[-1] 	# subdiagonal
#
# u <- solve(y, un)
## (3) TURBULENT MIXING OF MIXED LAYER
# the mixed layer depth is determined for each time step by comparing kinetic
# energy available from wind and the potential energy required to completely
# mix the water column to a given depth
Zcv <- seq(1, nx) %*% area / sum(area) # center of volume
tau = 1.225 * Cd * Uw(n * dt)^2 # wind shear is air density times wind velocity
if (Uw(n * dt) <= 15) {
c10 = 0.0005 * sqrt(Uw(n * dt))
} else {
c10 = 0.0026
}
shear = sqrt((c10 * calc_dens(un[1]))/1.225) *  Uw(n * dt) # shear velocity
# coefficient times wind velocity squared
KE = shear *  tau * dt # kinetic energy as function of wind
if (ice){
KE = KE * KEice
}
maxdep = 1
for (dep in 1:(nx-1)){
if (dep == 1){
# PE = abs(g *  ( seq(1,nx)[dep] - Zcv)  * calc_dens(u[dep]) * dx)
PE = abs(g *   seq(1,nx)[dep] *( seq(1,nx)[dep+1] - Zcv)  *
abs(calc_dens(u[dep+1])- calc_dens(u[dep])))
} else {
PEprior = PE
# PE = abs(g *  ( seq(1,nx)[dep] - Zcv)  * calc_dens(u[dep]) * dx +
#            PEprior)
PE = abs(g *   seq(1,nx)[dep] *( seq(1,nx)[dep+1] - Zcv)  *
abs(calc_dens(u[dep+1])- calc_dens(u[dep]))) + PEprior
}
if (PE > KE){
maxdep = dep-1
break
} else if (dep>1 & PE < KE ){
u[(dep-1):dep] = (u[(dep-1):dep] %*% volume[(dep-1):dep])/sum(volume[(dep-1):dep])
}
maxdep = dep
}
# u[1:maxdep] = (u[1:(maxdep)] %*% volume[1:(maxdep)])/sum(volume[1:(maxdep)]) #mean(u[1:maxdep])
mix[n] <- KE/PE #append(mix, KE/PE)
therm.z[n] <- maxdep #append(therm.z, maxdep)
## (4) DENSITY INSTABILITIES
# convective overturn: Convective mixing is induced by an unstable density
# profile. All groups of water layers where the vertical density profile is
# unstable are mixed with the first stable layer below the unstable layer(s)
# (i.e., a layer volume weighed means of temperature and other variables are
# calculated for the mixed water column). This procedure is continued until
# the vertical density profile in the whole water column becomes neutral or stable.
dens_u = calc_dens(u)
diff_dens_u <- (diff(dens_u))
diff_dens_u[abs(diff(dens_u)) < densThresh] = 0
while (any(diff_dens_u < 0)){
dens_u = calc_dens(u)
for (dep in 1:(nx-1)){
if (dens_u[dep+1] < dens_u[dep] & abs(dens_u[dep+1] - dens_u[dep]) > densThresh){
u[dep:(dep+1)] = (u[dep:(dep+1)] %*% volume[dep:(dep+1)])/sum(volume[dep:(dep+1)]) #mean(u[dep:(dep+1)])
break
}
}
dens_u = calc_dens(u)
diff_dens_u <- (diff(dens_u))
diff_dens_u[abs(diff(dens_u)) < densThresh] = 0
}
dens_u_n2 = calc_dens(u)
n2 <- 9.81/mean(calc_dens(u)) * (lead(dens_u_n2) - lag(dens_u_n2))/dx
max.n2 <- ifelse(max(n2, na.rm = T) > 1E-4, which.max(n2) * dx, dx * nx)
mix.z[n] <- max.n2
## (5) ICE FORMATION
# according to Hostetler & Bartlein (1990):
# (1) ice forms when surface water temp <= 1 deg C and melts when > 1 deg
# (2) rate of ice formation/melting is exponential function of ice thickness
# (the thicker the ice, the slower the formation rate, and vice versa)
# (3) heat of fusion is added/subtracted from surface energy balance
# (4) diffusion below ice only happens on molecular level
# (5) with ice, surface absorption of incoming solar radiation increases to 85 %
icep  = max(dt_iceon_avg,  (dt/86400))
x = (dt/86400) / icep
iceT = iceT * (1 - x) + u[1] * x
if ((iceT <= 0) == TRUE){
# if (any(u <= 0) == TRUE){
supercooled <- which(u < 0)
initEnergy <- sum((0-u[supercooled])*hyps$Area_meterSquared[supercooled] * dx * 4.18E6)
if (ice != TRUE) {
Hi <- 0.01+(initEnergy/(910*333500))/max(hyps$Area_meterSquared)
} else {
if (Tair(n*dt) > 0){
Tice <- 0
Hi = Hi -max(c(0, meltP * dt*(((1-0.4)*Jsw(n * dt))+(longwave(cc = CC(n * dt), sigma = sigma, Tair = Tair(n * dt), ea = ea(n * dt), emissivity = emissivity, Jlw = Jlw(n * dt)) +
backscattering(emissivity = emissivity, sigma = sigma, Twater = un[1]) +
latent(Tair = Tair(n*dt), Twater = un[1], Uw = Uw(n *dt), p2 = p2, pa = Pa(n*dt), ea=ea(n*dt)) +
sensible(p2 = p2, B = B, Tair = Tair(n*dt), Twater = un[1], Uw = Uw(n * dt))) )/(1000*333500)))
} else {
Tice <-  ((1/(10 * Hi)) * 0 +  Tair(n*dt)) / (1 + (1/(10 * Hi)))
Hi <- sqrt(Hi**2 + 2 * 2.1/(910 * 333500)* (0 - Tice) * dt)
}
}
ice = TRUE
if (Hi > 0){
u[supercooled] = 0
u[1] = 0
}
Him[n] <- Hi
} else if (ice == TRUE & Hi > 0) {
if (Tair(n*dt) > 0){
Tice <- 0
Hi = Hi -max(c(0, meltP * dt*(((1-0.2)*Jsw(n * dt))+(backscattering(emissivity = emissivity, sigma = sigma, Twater = un[1]) +
latent(Tair = Tair(n*dt), Twater = un[1], Uw = Uw(n *dt), p2 = p2, pa = Pa(n*dt), ea=ea(n*dt)) +
sensible(p2 = p2, B = B, Tair = Tair(n*dt), Twater = un[1], Uw = Uw(n * dt))) )/(1000*333500)))
} else {
Tice <-  ((1/(10 * Hi)) * 0 +  Tair(n*dt)) / (1 + (1/(10 * Hi)))
Hi <- sqrt(Hi**2 + 2 * 2.1/(910 * 333500)* (0 - Tice) * dt)
}
u[supercooled] = 0
u[1] = 0
Him[n] <- Hi
} else if (ice == TRUE & Hi <= 0){
ice = FALSE
}
n2m[, n] <- n2
um[, n] <- u
lines( u, seq(0, dx * nx, length.out=(nx)),
ylim = rev(range(seq(0, dx * nx, length.out=(nx)))), lty = 'dashed');
# print(un)
# print(u)
# cat ("Press [enter] to continue")
# line <- readline()
}
str(um)
## water temperature time series at different depths
plot(seq(1, ncol(um))*dt/24/3600, um[1,], col = 'red', type = 'l',
xlab = 'Time (d)', ylab='Temperature (degC)', ylim=c(-1,35), lwd = 2)
for (i in 2:nx){
lines(seq(1, ncol(um))*dt/24/3600, um[i,], col = sample(col_vector,1),
lty = 'dashed',lwd =2)
}
# ice thickness (direct model output)
plot(seq(1, ncol(um))*dt/24/3600, Him, type = 'l',
col = 'red', xlab = 'Time',
ylab= 'Ice thickness (m)', lwd= 3)
## surface mixed layer depth (direct model output)
therm.z.roll = zoo::rollmean(therm.z, 14)
plot(seq(1, ncol(um))*dt/24/3600, therm.z, type = 'l',ylim = rev(range( seq(0,zmax, length.out=nx))),
col = 'red', xlab = 'Time',
ylab= 'Mixed Layer Depth (m)', lwd= 3)
lines(therm.z.roll, lty ='dashed', lwd =3)
## decision if lake is stratified or not: 1 deg C criterium
strat.state <- um[1,] - um[nx,]
strat.state <- ifelse(strat.state > 1, 1, 0)
plot(seq(1, ncol(um))*dt/24/3600, strat.state, col = 'red', type = 'l',
xlab = 'Time (d)', ylab='Stratified conditions', ylim=c(0,1), lwd = 2)
## max. buoyancy frequency layer depth (direct model output)
mix.z.roll = zoo::rollmean(mix.z, 14)
plot(mix.z, type = 'l',ylim = rev(range( seq(0,zmax, length.out=nx))),
col = 'red', xlab = 'Time',
ylab= 'Max. Buoyancy Freq. Depth (m)', lwd= 3)
lines(mix.z.roll, lty ='dashed', lwd =3)
## check stratification durations
df.ice <- data.frame('time' = startDate + seq(1, ncol(um))*dt,
'ice' = Him,
'stratified' = strat.state)
g.ice <- ggplot(df.ice) +
geom_line(aes(time, ice)) +
ylab('ice thickness (m)') + xlab('')+
geom_line(aes(time, stratified),
linetype = 2, col = 'blue') +
scale_y_continuous(sec.axis = sec_axis(trans = ~ . & 1,
name = "stratified (yes/no)")) +
theme_minimal();g.ice
# meteorological heat fluxes
fluxes.df <- data.frame('time' = seq(1, ncol(um))*dt/24/3600,
'shortwave' = Swf,
'longwavein' = Lwf,
'longwaveout' = BLwf,
'latent' = Lf,
'sensible' = Sf,
'total' = Swf + Lwf + BLwf + Lf + Sf)
m.fluxes.df <- reshape2::melt(fluxes.df, id = 'time')
ggplot(m.fluxes.df) +
geom_line(aes(time, value)) +
facet_wrap(~ variable, scales = 'free')
## vertical water temperature profiles over time
df = data.frame('1' =NULL)
name = NULL
for (i in seq(1,ncol(um), length.out = 20)){
i = floor(i)
name = append(name, round((i*dt)/24/3600,1))
df = append(df, data.frame('1' = um[,i] + round((i*dt)/24/3600,1)))
}
df.m = matrix(unlist(df), ncol = 20)
colnames(df.m) = name
df.m.m = reshape2::melt(df.m)
ggplot2::ggplot(df.m.m) +
geom_point(aes(x = value/40, y=Var1,  col = value-Var2, group = Var2)) +
geom_line(aes(x = value/40, y=Var1,  col = value-Var2, group = Var2)) +
scale_y_reverse() + xlab('Time') + ylab('Depth')+labs(col='Temp')+
scale_color_gradient(low = "lightblue", high = "red") +
theme_minimal()
## vertical temperature profiles
# for (i in seq(1,ncol(um), length.out = 200)){
#   n = i
#   i = floor(i)
#   png(paste0('../../animation_macrophyte/pic_',match(n, seq(1,ncol(um),
# length.out=200)),'.png'))
#   plot(um[,i], seq(dx,zmax, length.out=nx),
#        ylim = rev(range( seq(dx,zmax, length.out=nx))), col = 'red',
# type = 'l', xlab = 'Temperature (degC)',
#        ylab='Depth (m)',
#        xlim = c(0,35), main = paste0('time (d): ',round((i*dt)/24/3600,1)),
#        lwd = 3)
#   dev.off()
# }
#
## contour plot of water temperature
# time =  seq(1, ncol(um))*dt/24/3600
time =  startDate + seq(1, ncol(um))*dt
df <- data.frame(cbind(time, t(um)) )
colnames(df) <- c("time", as.character(paste0(seq(1,nrow(um)))))
m.df <- reshape2::melt(df, "time")
m.df$time <- as.POSIXct(time)
df.kz <- data.frame(cbind(time, t(kzm)) )
colnames(df.kz) <- c("time", as.character(paste0(seq(1,nrow(kzm)))))
m.df.kz <- reshape2::melt(df.kz, "time")
m.df.kz$time <- as.POSIXct(time)
df.n2 <- data.frame(cbind(time, t(n2m)) )
colnames(df.n2) <- c("time", as.character(paste0(seq(1,nrow(n2m)))))
m.df.n2 <- reshape2::melt(df.n2, "time")
m.df.n2$time <- as.POSIXct(time)
g1 <- ggplot(m.df, aes((time), as.numeric(variable))) +
geom_raster(aes(fill = as.numeric(value)), interpolate = TRUE) +
scale_fill_gradientn(limits = c(-2,35),
colours = rev(RColorBrewer::brewer.pal(11, 'Spectral')))+
theme_minimal()  +xlab('Time') +
ylab('Depth') +
labs(fill = 'Temp [degC]')+
scale_y_reverse()
g2 <- ggplot(m.df.kz, aes((time), as.numeric(variable))) +
geom_raster(aes(fill = as.numeric(value)), interpolate = TRUE) +
scale_fill_gradientn(#limits = c(-20,35),
colours = rev(RColorBrewer::brewer.pal(11, 'Spectral')))+
theme_minimal()  +xlab('Time') +
ylab('Depth') +
labs(fill = 'Diffusion [m2/s]')+
scale_y_reverse()
g3 <- ggplot(m.df.n2, aes((time), as.numeric(variable))) +
geom_raster(aes(fill = as.numeric(value)), interpolate = TRUE) +
scale_fill_gradientn(#limits = c(-20,35),
colours = rev(RColorBrewer::brewer.pal(11, 'Spectral')))+
theme_minimal()  +xlab('Time') +
ylab('Depth') +
labs(fill = 'N2 [s-2]')+
scale_y_reverse()
g <- g1 / g2 / g3 / g.ice; g
ggsave(filename = 'heatmap.png',plot = g, width = 15, height = 8, units = 'in')
# Package ID: knb-lter-ntl.130.29 Cataloging System:https://pasta.edirepository.org.
# Data set title: North Temperate Lakes LTER: High Frequency Water Temperature Data - Lake  Mendota Buoy 2006 - current.
inUrl2  <- "https://pasta.lternet.edu/package/data/eml/knb-lter-ntl/130/29/63d0587cf326e83f57b054bf2ad0f7fe"
infile2 <- tempfile()
try(download.file(inUrl2,infile2,method="curl"))
if (is.na(file.size(infile2))) download.file(inUrl2,infile2,method="auto")
dt2 <-read.csv(infile2,header=F
,skip=1
,sep=","
,quot='"'
, col.names=c(
"sampledate",
"year4",
"month",
"daynum",
"hour",
"depth",
"wtemp",
"flag_wtemp"    ), check.names=TRUE)
unlink(infile2)
# attempting to convert dt2$sampledate dateTime string to R date structure (date or POSIXct)
tmpDateFormat<-"%Y-%m-%d"
tmp2sampledate<-as.Date(dt2$sampledate,format=tmpDateFormat)
# Keep the new dates only if they all converted correctly
if(length(tmp2sampledate) == length(tmp2sampledate[!is.na(tmp2sampledate)])){dt2$sampledate <- tmp2sampledate } else {print("Date conversion failed for dt2$sampledate. Please inspect the data and do the date conversion yourself.")}
rm(tmpDateFormat,tmp2sampledate)
if (class(dt2$year4)=="factor") dt2$year4 <-as.numeric(levels(dt2$year4))[as.integer(dt2$year4) ]
if (class(dt2$year4)=="character") dt2$year4 <-as.numeric(dt2$year4)
if (class(dt2$month)=="factor") dt2$month <-as.numeric(levels(dt2$month))[as.integer(dt2$month) ]
if (class(dt2$month)=="character") dt2$month <-as.numeric(dt2$month)
if (class(dt2$daynum)=="factor") dt2$daynum <-as.numeric(levels(dt2$daynum))[as.integer(dt2$daynum) ]
if (class(dt2$daynum)=="character") dt2$daynum <-as.numeric(dt2$daynum)
if (class(dt2$depth)=="factor") dt2$depth <-as.numeric(levels(dt2$depth))[as.integer(dt2$depth) ]
if (class(dt2$depth)=="character") dt2$depth <-as.numeric(dt2$depth)
if (class(dt2$wtemp)=="factor") dt2$wtemp <-as.numeric(levels(dt2$wtemp))[as.integer(dt2$wtemp) ]
if (class(dt2$wtemp)=="character") dt2$wtemp <-as.numeric(dt2$wtemp)
if (class(dt2$flag_wtemp)!="factor") dt2$flag_wtemp<- as.factor(dt2$flag_wtemp)
dt2
dt2$datetime <- as.POSIXct(paste0(dt2$sampledate,' ',dt2$hour,':00:00'), format = "%Y-%m-%d %H:%M:%S")
# Package ID: knb-lter-ntl.29.29 Cataloging System:https://pasta.edirepository.org.
# Data set title: North Temperate Lakes LTER: Physical Limnology of Primary Study Lakes 1981 - current.
# inUrl3 <- "https://pasta.lternet.edu/package/data/eml/knb-lter-ntl/29/29/03e232a1b362900e0f059859abe8eb97"
# infile3 <- tempfile()
# download.file(inUrl3, infile3, method = "curl")
# dt1 <- read_csv(infile3, skip = 1, quote = "\"", guess_max = 1e+05,
#                 col_names = c("lakeid", "year4", "daynum", "sampledate",
#                               "depth", "rep", "sta", "event", "wtemp", "o2", "o2sat",
#                               "deck", "light", "frlight", "flagdepth", "flagwtemp",
#                               "flago2", "flago2sat", "flagdeck", "flaglight", "flagfrlight"))
# dt1
# time =  startDate + seq(1, ncol(um))*dt#/24/3600
# obs <- dt1 %>%
#   filter(lakeid == 'ME') %>%
#   rename(datetime = sampledate) %>%
#   select(datetime, depth, wtemp)
time =  startDate + seq(1, ncol(um))*dt#/24/3600
obs <- dt2 %>%
select(datetime, depth, wtemp)
df.sim <- df
colnames(df.sim) <- c("datetime", as.character(paste0('wtemp.',seq(1,nrow(um))*dx)))
df.sim$datetime <-   startDate + seq(1, ncol(um))*dt#/24/3600
# idx <- na.omit(match(as.POSIXct(df.sim$datetime), as.POSIXct(obs$datetime) ))
idx <- (match(as.POSIXct(obs$datetime), as.POSIXct(df.sim$datetime) ))
# df.sim <- df.sim[idx, ]
obs <- obs[which(!is.na(idx)), ]
idz <- which(obs$depth %in% seq(0,24,1))
obs = obs[idz,]
deps <- seq(1,nrow(um))*dx
if (min(unique(obs$depth)) < min(deps)){
deps[which.min(deps)] <- min(unique(obs$depth))
}
if (max(unique(obs$depth)) > max(deps)){
deps[which.max(deps)] <- max(unique(obs$depth))
}
df.sim.interp <- NULL
for (i in 1:nrow(df.sim)){
df.sim.interp <- rbind(df.sim.interp,
approx(deps, df.sim[i, -1], unique(obs$depth))$y)
}
df.sim.interp <- as.data.frame(df.sim.interp)
# df.sim.interp <- apply(df.sim[,-1], 1, function(x) approx(deps, x, unique(obs$temp_depth_m))$y)
df.sim.interp$datetime <-   startDate + seq(1, ncol(um))*dt#/24/3600
colnames(df.sim.interp) <- c(as.character(paste0('wtemp.',unique(obs$depth))), 'datetime')
obs <- data.frame(obs)
obs$depth <- factor(obs$depth)
wide.obs <- reshape(obs, idvar = "datetime", timevar = "depth", direction = "wide")
m.obs <- reshape2::melt(wide.obs, id = 'datetime')
m.obs$datetime <- as.POSIXct(m.obs$datetime)
m.obs$group <- 'obs'
m.df.sim.interp <- reshape2::melt(df.sim.interp, id = 'datetime')
m.df.sim.interp$group <- 'sim'
rmse <- data.frame('variable' = NULL, 'fit' = NULL)
for (i in unique(as.character(m.obs$variable))){
o <- m.obs
o$variable <- as.character(o$variable)
o = o %>%
filter(variable == i)
s <- m.df.sim.interp
s$variable <- as.character(s$variable)
s = s %>%
filter(variable == i)
id.r <-  (match(as.POSIXct(s$datetime), as.POSIXct(o$datetime) ))
s <- s[which(!is.na(id.r)),]
rmse <- rbind(rmse, data.frame('variable' = i,
'fit' = sqrt((sum((o$value-s$value)**2, na.rm = T))/nrow(o))))
}
m.obs$variable <-  factor(m.obs$variable, levels=paste0('wtemp.',seq(0,24,1)))
m.df.sim.interp$variable <-  factor(m.df.sim.interp$variable, levels=paste0('wtemp.',seq(0,24,1)))
ggplot() +
geom_point(data = m.obs,aes(datetime, value, col = group)) +
geom_line(data = m.df.sim.interp, aes(datetime, value, col = group)) +
geom_text(data=rmse, aes( as.POSIXct("2010-01-01 10:30:00 CDT"), y=17, label=round(fit,2)),
color="black", size =3) +
facet_wrap(~ factor(variable, level = c(paste0('wtemp.',seq(0,24,1))))) +
xlab('') + ylab('Temp. (deg C)')+
theme_bw()
ggsave(filename = 'fieldcomp.png', width = 15, height = 8, units = 'in')
